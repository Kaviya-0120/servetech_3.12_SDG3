{% extends "base.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1>Admin Dashboard</h1>
    <form action="{{ url_for('reset_system') }}" method="POST"
        onsubmit="return confirm('Are you sure you want to clear all patient data?');" style="margin: 0;">
        <button type="submit" class="btn" style="background-color: #dc3545;">Clear All Patient Data</button>
    </form>
</div>

<div class="dashboard-grid">
    <div class="stat-card">
        <h3>{{ stats['total_patients'] }}</h3>
        <p>Total Patients</p>
    </div>
    <div class="stat-card">
        <h3>{{ stats['total_doctors'] }}</h3>
        <p>Total Doctors</p>
    </div>
    <div class="stat-card">
        <h3>{{ stats['dept_stats']|length }}</h3>
        <p>Active Departments</p>
    </div>
</div>

<div class="dashboard-grid">
    <div class="card">
        <div class="card-header">Patients per Department</div>
        <canvas id="deptChart"></canvas>
    </div>

    <div class="card">
        <div class="card-header">Recent Activity</div>
        <ul>
            {% for p in stats['recent_patients'] %}
            <li>
                <strong>{{ p['name'] }}</strong> - {{ p['dept_name'] }}
                <span class="badge badge-{{ p['priority_level']|lower }}">{{ p['priority_level'] }}</span>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>

<div class="card">
    <div class="card-header">Department Load</div>
    <table>
        <thead>
            <tr>
                <th>Department</th>
                <th>Patient Count</th>
            </tr>
        </thead>
        <tbody>
            {% for dept in stats['dept_stats'] %}
            <tr>
                <td>{{ dept['name'] }}</td>
                <td>{{ dept['count'] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script id="dept-stats-data" type="application/json">{{ stats['dept_stats'] | tojson }}</script>

<script>
    // Prepare data for Chart.js
    const rawData = JSON.parse(document.getElementById('dept-stats-data').textContent);
    const deptLabels = rawData.map(item => item.name);
    const deptData = rawData.map(item => item.count);

    const ctx = document.getElementById('deptChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: deptLabels,
            datasets: [{
                label: '# of Patients',
                data: deptData,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(153, 102, 255, 0.2)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>
{% endblock %}